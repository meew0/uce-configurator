<!doctype html>
<html>
    <head>
    </head>
    <body>
        <script type="text/javascript" charset="utf-8" src="./utils.js"></script>
        <script type="text/javascript" charset="utf-8" src="./binl_md5.js"></script>
        <script type="text/javascript" charset="utf-8" src="./shift_jis.js"></script>
        <script type="text/javascript" charset="utf-8" src="./ucec.js"></script>
        <script type="text/javascript" charset="utf-8" src="./fnt.js"></script>
        <script type="text/javascript" charset="utf-8" src="./layout.js"></script>
        <script type="text/javascript" charset="utf-8" src="./snr.js"></script>
        <script type="text/javascript">
            const romPickerOptions = {
                types: [
                    {
                        description: "shin engine ROM files",
                        accept: {
                            "application/x-shin-rom": ".rom"
                        }
                    }
                ]
            };

            const fntPickerOptions = {
                types: [
                    {
                        description: "shin engine font files",
                        accept: {
                            "application/x-shin-fnt": ".fnt"
                        }
                    }
                ]
            };

            var regularFnt, boldFnt;

            async function selectFileAsBlob(pickerOptions) {
                const [file] = await window.showOpenFilePicker(pickerOptions);
                return await file.getFile();
            }

            async function selectAndReadRomFile() {
                return await readRomFile(await selectFileAsBlob(romPickerOptions));
            }

            async function selectAndWriteRomFile(romFile) {
                const newHandle = await window.showSaveFilePicker();
                const writableStream = await newHandle.createWritable();
                await writeRomFile(writableStream, romFile);
                await writableStream.close();
            }

            async function* getFilesRecursively(entry, base) {
                // Skip first level
                let relativePath = base == null ? [] : base.concat([entry.name]);

                if (entry.kind === "file") {
                    const file = await entry.getFile();
                    if (file !== null) {
                        file.relativePath = relativePath;
                        yield file;
                    }
                } else if (entry.kind === "directory") {
                    for await (const handle of entry.values()) {
                        yield* getFilesRecursively(handle, relativePath);
                    }
                }
            }

            async function fetchFont(path) {
                const ds = new DecompressionStream("gzip");
                const response = await fetch(path);
                const decompressedStream = response.body.pipeThrough(ds);
                return await new Response(decompressedStream).blob();
            }

            async function fetchNewrodin() {
                regularFnt = await fetchFont('data/fonts/newrodin-medium.fnt.gz');
                boldFnt = await fetchFont('data/fonts/newrodin-medium.fnt.gz');
            }

            async function readRom() {
                console.log(await selectAndReadRomFile());
            }

            async function rewriteRom() {
                const romFile = await selectAndReadRomFile();
                console.log(romFile);
                await selectAndWriteRomFile(romFile);
            }

            async function loadFonts() {
                regularFnt = await selectFileAsDataSource(fntPickerOptions);
                boldFnt = await selectFileAsDataSource(fntPickerOptions);
            }

            async function changeFonts() {
                const romFile = await selectAndReadRomFile();

                patchFileInRom(romFile, ['newrodin-medium.fnt'], new FileDataSource(regularFnt));
                patchFileInRom(romFile, ['newrodin-bold.fnt'], new FileDataSource(boldFnt));
                console.log(romFile);

                await selectAndWriteRomFile(romFile);
            }

            async function dirToRom() {
                const directory = await window.showDirectoryPicker();
                const romFile = newRomFile();
                for await (const file of getFilesRecursively(directory)) {
                    const dataSource = new FileDataSource(file);
                    patchFileInRom(romFile, file.relativePath, dataSource);
                }
                console.log(romFile);
                await selectAndWriteRomFile(romFile);
            }

            var scenario;

            async function readScenario() {
                const ds = new DecompressionStream("gzip");
                const response = await fetch('data/main_snr.json.gz');
                const decompressedStream = response.body.pipeThrough(ds);
                scenario = await new Response(decompressedStream).json();
                console.log(`Read scenario (${scenario.dialogueLineCount} dialogue lines)`);
            }

            async function writeSnr() {
                if(regularFnt == undefined) {
                    await fetchNewrodin();
                }

                const layouter = new WordWrapLayouter(await readFntFile(regularFnt, false), await readFntFile(boldFnt, false));
                const compiled = compileSnr(scenario, 6, 19, 88, {}, layouter);

                const newHandle = await window.showSaveFilePicker();
                const writableStream = await newHandle.createWritable();
                await writableStream.write(compiled);
                await writableStream.close();
            }
        </script>
        <button onclick="readRom()">read rom</button>
        <button onclick="rewriteRom()">rewrite rom</button>
        <button onclick="loadFonts()">load fonts</button>
        <button onclick="changeFonts()">change fonts</button>
        <button onclick="dirToRom()">directory to rom</button>
        <button onclick="readScenario()">read scenario</button>
        <button onclick="writeSnr()">write snr</button>
    </body>
</html>
