<!doctype html>
<html>
    <head>
    </head>
    <body>
        <script type="text/javascript" src="./binl_md5.js"></script>
        <script type="text/javascript" src="./ucec.js"></script>
        <script type="text/javascript">
            const romPickerOptions = {
                types: [
                    {
                        description: "shin engine ROM files",
                        accept: {
                            "application/x-shin-rom": ".rom"
                        }
                    }
                ]
            };

            const fntPickerOptions = {
                types: [
                    {
                        description: "shin engine font files",
                        accept: {
                            "application/x-shin-fnt": ".fnt"
                        }
                    }
                ]
            };

            async function selectAndReadRomFile() {
                const [file] = await window.showOpenFilePicker(romPickerOptions);
                const fileBlob = await file.getFile();
                return await readRomFile(fileBlob);
            }

            async function selectFileAsDataSource(pickerOptions) {
                const [file] = await window.showOpenFilePicker(pickerOptions);
                const fileBlob = await file.getFile();
                return new FileDataSource(fileBlob);
            }

            async function selectAndWriteRomFile(romFile) {
                const newHandle = await window.showSaveFilePicker();
                const writableStream = await newHandle.createWritable();
                await writeRomFile(writableStream, romFile);
                await writableStream.close();
            }

            async function readRom() {
                console.log(await selectAndReadRomFile());
            }

            async function rewriteRom() {
                const romFile = await selectAndReadRomFile();
                console.log(romFile);
                await selectAndWriteRomFile(romFile);
            }

            async function changeFonts() {
                const romFile = await selectAndReadRomFile();
                const regularFnt = await selectFileAsDataSource(fntPickerOptions);
                const boldFnt = await selectFileAsDataSource(fntPickerOptions);

                patchFileInRom(romFile, ['newrodin-medium.fnt'], regularFnt);
                patchFileInRom(romFile, ['newrodin-bold.fnt'], boldFnt);
                console.log(romFile);

                await selectAndWriteRomFile(romFile);
            }
        </script>
        <button onclick="readRom()">read rom</button>
        <button onclick="rewriteRom()">rewrite rom</button>
        <button onclick="changeFonts()">change fonts</button>
    </body>
</html>
